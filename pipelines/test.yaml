apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: execute-kubeflow-pipeline
  namespace: ml
spec:
  description: Execute a Jupyter notebook to launch a Kubeflow pipeline
  params:
    - name: IMAGE
      type: string
    - name: TAG
      type: string
      default: latest
    - name: NOTEBOOK_PATH
      type: string
    - name: KUBEFLOW_ENDPOINT
      type: string
    - name: WEBSITE_URL
      type: string
    - name: VECTORDB_INDEX
      type: string
    - name: PATH_CONTEXT
      type: string
  workspaces:
    - name: source
  steps:
    - name: run-notebook
      image: "$(params.IMAGE):$(params.TAG)"
      workingDir: "$(workspaces.source.path)/$(params.PATH_CONTEXT)"
      script: |
        #!/bin/sh
        set -e
        pip install --no-cache-dir jupyter pandas numpy
        jupyter nbconvert --to notebook --execute $(params.NOTEBOOK_PATH)
