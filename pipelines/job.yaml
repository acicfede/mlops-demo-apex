apiVersion: batch/v1
kind: Job
metadata:
  name: untitled1-pipeline-job
  namespace: ml
spec:
  template:
    spec:
      serviceAccountName: pipeline-runner
      restartPolicy: Never
      volumes:
        - name: pipeline-files
          configMap:
            name: pipeline-files-configmap
        - name: workspace
          emptyDir: {}
      initContainers:
        - name: prepare-workspace
          image: quay.io/quay/busybox:latest
          command: ["sh", "-c"]
          args:
            - mkdir -p /workspace/jupyter-work-dir
          volumeMounts:
            - mountPath: /workspace/jupyter-work-dir
              name: workspace
      containers:
        - name: elyra-runner
          image: quay.io/modh/runtime-images@sha256:2932e07edbcbc54e68959cc6bc5c16c6b07766453a3ac655bdc33b844108c541
          command: ["sh", "-c"]
          args:
            - |
              cd /workspace/jupyter-work-dir
              # scarica bootstrapper e requirements Elyra
              [[ -f bootstrapper.py ]] || curl -k -L https://raw.githubusercontent.com/opendatahub-io/elyra/v4.2.0/elyra/kfp/bootstrapper.py -o bootstrapper.py
              [[ -f requirements-elyra.txt ]] || curl -k -L https://raw.githubusercontent.com/opendatahub-io/elyra/v4.2.0/etc/generic/requirements-elyra.txt -o requirements-elyra.txt

              # installa pip, packaging e pacchetti richiesti
              python3 -m pip install --upgrade pip packaging
              python3 -m pip install -r requirements-elyra.txt

              # esegui bootstrapper
              python3 bootstrapper.py --pipeline-name "untitled1" \
                --cos-endpoint "https://minio-api-ml.apps.privateailab.acic.accenture" \
                --cos-bucket "mlpipeline-artifacts" \
                --cos-directory "untitled1-$(date +%s)" \
                --cos-dependencies-archive "Part1-Data-Cleaning.tar.gz" \
                --file "/workspace/pipelines/Part1-Data-Cleaning.ipynb"
          volumeMounts:
            - mountPath: /workspace/pipelines
              name: pipeline-files
            - mountPath: /workspace/jupyter-work-dir
              name: workspace
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: minio-secret
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secret
                  key: AWS_SECRET_ACCESS_KEY
            - name: S3_VERIFY_SSL
              value: "false"  # salta la verifica SSL
  backoffLimit: 1
