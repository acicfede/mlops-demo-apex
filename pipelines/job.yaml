apiVersion: batch/v1
kind: Job
metadata:
  name: untitled1-pipeline-job
  namespace: ml
spec:
  template:
    spec:
      serviceAccountName: pipeline-runner
      restartPolicy: Never
      containers:
      - name: elyra-runner
        image: quay.io/modh/runtime-images@sha256:2932e07edbcbc54e68959cc6bc5c16c6b07766453a3ac655bdc33b844108c541
        env:
          # Percorso del certificato CA di OpenShift
          - name: SSL_CERT_FILE
            value: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: minio-secret
                key: AWS_ACCESS_KEY_ID
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-secret
                key: AWS_SECRET_ACCESS_KEY
        command:
          - sh
          - -c
          - |
            # Usa un percorso temporaneo scrivibile
            mkdir -p /tmp/jupyter-work-dir
            cd /tmp/jupyter-work-dir

            # Scarica bootstrapper e requirements usando il certificato OpenShift
            curl --cacert $SSL_CERT_FILE -L https://raw.githubusercontent.com/opendatahub-io/elyra/v4.2.0/elyra/kfp/bootstrapper.py -o bootstrapper.py
            curl --cacert $SSL_CERT_FILE -L https://raw.githubusercontent.com/opendatahub-io/elyra/v4.2.0/etc/generic/requirements-elyra.txt -o requirements-elyra.txt

            # Installa pacchetti richiesti
            python3 -m pip install --upgrade pip
            python3 -m pip install packaging
            python3 -m pip freeze > requirements-current.txt

            # Esegui bootstrapper.py per ciascun notebook
            python3 bootstrapper.py --pipeline-name "untitled1" \
              --cos-endpoint "https://minio-api-ml.apps.privateailab.acic.accenture" \
              --cos-bucket "mlpipeline-artifacts" \
              --cos-directory "untitled1-$(date +%s)" \
              --cos-dependencies-archive "Part1-Data-Cleaning.tar.gz" \
              --file "/workspace/pipelines/Part1-Data-Cleaning.ipynb"

            python3 bootstrapper.py --pipeline-name "untitled1" \
              --cos-endpoint "https://minio-api-ml.apps.privateailab.acic.accenture" \
              --cos-bucket "mlpipeline-artifacts" \
              --cos-directory "untitled1-$(date +%s)" \
              --cos-dependencies-archive "Part2-Data-Analysis.tar.gz" \
              --file "/workspace/pipelines/Part2-Data-Analysis.ipynb"

            python3 bootstrapper.py --pipeline-name "untitled1" \
              --cos-endpoint "https://minio-api-ml.apps.privateailab.acic.accenture" \
              --cos-bucket "mlpipeline-artifacts" \
              --cos-directory "untitled1-$(date +%s)" \
              --cos-dependencies-archive "Part3-Time-Series-Forecasting.tar.gz" \
              --file "/workspace/pipelines/Part3-Time-Series-Forecasting.ipynb"

        volumeMounts:
          - name: pipeline-files
            mountPath: /workspace/pipelines
      volumes:
        - name: pipeline-files
          configMap:
            name: pipeline-files-configmap
        - name: tmp-workspace
          emptyDir: {}
  backoffLimit: 1
